# Codex MCP サーバー設計ノート

英語版（`mcp-server-discussion.md`）をアクティブ設計ノートの基準とします。
この文書は同期済みの日本語翻訳版です。

## 運用ルール

- この文書は固定の最終仕様ではなく、継続更新する設計ログです。
- 意思決定が発生したら即時更新します。
- 長いセッション後にまとめて更新せず、増分で記録します。

## 問題定義

- ユーザーは曖昧な目標から始めることが多いです。
- 構造化された明確化なしで直接実行すると、不一致と手戻りが発生します。
- 意図・計画・実行の結び付きが弱いと信頼性が低下します。

## プロダクト目標

Codex の信頼性を高めるローカル Go MCP サーバーを構築します。必須要件は以下です。
- 構造化された意図取得、
- 段階的な計画/実行/検証、
- 明示的なユーザー承認ゲート、
- 再開可能な永続状態。

## コア原則

- 出力速度より意図整合性を優先。
- 小さな確定と高速フィードバック。
- センシティブ境界での人間による統制。
- 追跡可能な状態を持つ再現可能ワークフロー。
- 回復可能な失敗ループ。
- 最小権限の実行デフォルト。

## 現在のアーキテクチャ要約

- ワークフロー状態機械を強制します。
- セッション永続化は JSON + SQLite を使用します。
- `generate_plan` 前に council ベースの企画を必須化します。
- 相談ループは 1 ターン 1 問の集中質問で要件を精緻化します。
- UI/UX タスクでは条件付きでビジュアルレビューゲートを要求します。
- 最終完了には明示的なユーザー承認が必要です。

## 動的 council チーム

- Council マネージャーはセッションスコープ（`council_managers`）です。
- チーム構成方法:
  - `council_configure_team`（`append|replace|remove`）
  - `council_start_briefing` でのワンショット更新（`manager_mode`, `managers`）
- トピック参加/クローズ判定は固定ロール一覧ではなく、アクティブなセッション管理者で行います。

## インストーラーポリシー

`make agent-install` には必須の同意/ヒアリングゲートを含めます。

1. 規約同意（必須）
   - ソフトウェアは十分に検証されていない
   - 問題/損害の責任はユーザーが負う
   - GNU GPL v3.0 を認識済み
2. インストール範囲選択（`global` または `local`）
3. Playwright MCP 登録（任意）
4. 初期専門性アンケートのプロファイル取得

インストーラーは既定ユーザープロファイルとランタイムランチャー連携を書き込みます。

## モデルルーティング基準

- 相談担当: `gpt-5.2`
- オーケストレーター/レビュアー: `gpt-5.3-codex`
- 実装担当: `gpt-5.3-codex-spark`

## 検証基準

- `make test` は必須で成功。
- `make smoke` は必須で成功。
- インストーラー変更は対話/非対話の両経路をサポート。

## 次回更新方針

- 英語文書を基準に維持します。
- 日本語文書が必要な場合は `*.ja.md` 対応文書を並行更新します。
