# Codex MCP 服务器设计说明

英文版（`mcp-server-discussion.md`）是活动设计说明的基准。
本文件是同步后的中文翻译版本。

## 运行规则

- 本文件是持续演进的设计日志，不是固定最终规格。
- 有新决策时要立即更新。
- 不要在长会话后集中补记，应按增量实时落盘。

## 问题定义

- 用户通常从模糊目标开始。
- 没有结构化澄清就直接执行，会导致偏差和返工。
- 当意图、计划、执行连接薄弱时，可靠性会下降。

## 产品目标

构建一个本地 Go MCP 服务器，通过以下机制提升 Codex 可靠性：
- 结构化意图采集，
- 分阶段计划/执行/验证，
- 显式用户批准门禁，
- 可恢复的持久化续跑能力。

## 核心原则

- 意图对齐优先于输出速度。
- 小步确认 + 快速反馈。
- 在敏感边界保留人工控制。
- 使用可追溯状态的可复现实工作流。
- 可恢复的失败闭环。
- 默认最小权限执行。

## 当前架构摘要

- 强制执行工作流状态机。
- 会话持久化采用 JSON + SQLite。
- `generate_plan` 前必须完成 council 规划。
- 咨询循环按“每轮一个聚焦问题”细化需求。
- UI/UX 任务在满足条件时必须通过视觉评审门禁。
- 最终完成必须有显式用户批准。

## 动态 council 团队

- Council 管理者按会话范围管理（`council_managers`）。
- 团队可通过以下方式配置：
  - `council_configure_team`（`append|replace|remove`）
  - 在 `council_start_briefing` 中一次性更新（`manager_mode`, `managers`）
- 议题参与/关闭校验基于当前会话中的活跃管理者，而非硬编码角色列表。

## 安装策略

`make agent-install` 包含强制同意/访谈门禁：

1. 条款同意（必需）
   - 软件尚未得到充分验证
   - 问题/损失责任由用户承担
   - 已确认 GNU GPL v3.0 许可
2. 安装范围选择（`global` 或 `local`）
3. 可选 Playwright MCP 注册
4. 初始专业度问卷画像采集

安装器会写入默认用户画像，并完成运行时 launcher 绑定。

## 模型路由基线

- 咨询角色：`gpt-5.2`
- 编排/评审角色：`gpt-5.3-codex`
- 执行角色：`gpt-5.3-codex-spark`

## 验证基线

- 必须通过 `make test`。
- 必须通过 `make smoke`。
- 安装器变更必须同时支持交互与非交互路径。

## 后续更新原则

- 以英文文档为主线维护。
- 如需中文文档，同步更新 `*.zh.md` 对应文件。
